---
- name: Create user namespaces and edit roles
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', item) | from_yaml }}"
  loop:
  - user-namespace.yml.j2
  - user-namespace-edit.yml.j2

- name: Setup Minio
  ansible.builtin.shell: |
    oc project $SUMMIT_PROJECT
    oc apply -k ./components/minio/base
    envsubst < components/create-bucket-job/base/create-bucket-job-template.yaml > components/create-bucket-job/base/create-bucket-job.yaml
    oc create configmap -n ${SUMMIT_PROJECT} model-config-file --from-file=IntroToML_Cert.pdf
    oc apply -k ./components/create-bucket-job/base
  args:
    chdir: ~/elyra_docling_rh_summit
  environment:
    SUMMIT_PROJECT: summit-project-{{ bootstrap_user_name_base }}{{ index }}

- name: Setup Openshift AI Workbench
  ansible.builtin.shell: |
    oc project $SUMMIT_PROJECT
    oc apply -f components/datascience-pipelines/secret-dashboard-dspa-secret.yaml
    envsubst < components/datascience-pipelines/dspa-template.yaml > components/datascience-pipelines/dspa.yaml
    oc apply -f components/datascience-pipelines/dspa.yaml
    export RHOAI_DASHBOARD=$(oc get routes -n redhat-ods-applications -o custom-columns=":spec.host" | grep rhods-dashboard)
    envsubst < components/workbenches/base/elyra-docling-workbench-template.yaml > components/workbenches/base/elyra-docling-workbench.yaml
    oc apply -k ./components/workbenches/base/
  args:
    chdir: ~/elyra_docling_rh_summit
  environment:
    SUMMIT_PROJECT: summit-project-{{ bootstrap_user_name_base }}{{ index }}

- name: Setup Pipeline triggers
  ansible.builtin.shell: |
    oc project $SUMMIT_PROJECT
    export OCP_APPS_URL=$(oc get ingresses.config.openshift.io cluster -o jsonpath='{.spec.domain}')
    envsubst < components/ocp-pipeline-triggers/task-python-task-template.yaml > components/ocp-pipeline-triggers/task-python-task.yaml
    envsubst < components/ocp-pipeline-triggers/el-route-template.yaml > components/ocp-pipeline-triggers/el-route.yaml
    oc apply -k components/ocp-pipeline-triggers/
  args:
    chdir: ~/elyra_docling_rh_summit
  environment:
    SUMMIT_PROJECT: summit-project-{{ bootstrap_user_name_base }}{{ index }}

- name: Setup Static Python Server for DSP file
  ansible.builtin.shell: |
    oc project $SUMMIT_PROJECT
    oc new-app quay.io/jhurlocker/static-file-python:latest --name=static-python-dsp
    #oc apply -f components/static-python/deployment.yaml
    envsubst < components/static-python/route-template.yaml > components/static-python/route.yaml
    oc apply -f components/static-python/route.yaml
  args:
    chdir: ~/elyra_docling_rh_summit
  environment:
    SUMMIT_PROJECT: summit-project-{{ bootstrap_user_name_base }}{{ index }}