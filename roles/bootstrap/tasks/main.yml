---
- name: Retrieve Ingress config
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: Ingress
    name: cluster
  register: r_ingress_config

- name: Clone {{ bootstrap_rh_submit_repo }}
  ansible.builtin.git:
    repo: "{{ bootstrap_rh_submit_repo }}"
    dest: ~/elyra_docling_rh_summit
    single_branch: yes
    version: rhpds

- name: Setup Openshift AI
  ansible.builtin.shell: |
    oc apply -k ./components/openshift-ai/instance/overlays/fast
  args:
    chdir: ~/elyra_docling_rh_summit

- name: Setup Openshift AI single serving runtime
  ansible.builtin.shell: |
    oc apply -k components/model-server/components-serving
  args:
    chdir: ~/elyra_docling_rh_summit

- name: Create granite model project
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'granite-model-namespace.yml.j2') | from_yaml }}"

- name: Setup user namespaces resources
  include_tasks: setup_user_namespace_resources.yml
  loop: "{{ range(0, bootstrap_num_users | int, 1) | list }}"
  loop_control:
    loop_var: n
  vars:
    index: "{{ n | int + 1 }}"

- name: Setup the model project - Create bucket job
  ansible.builtin.shell: |
    oc project $SUMMIT_PROJECT

    oc apply -k ./components/minio/base

    export MINIO_API_URL=$(oc get routes -n $SUMMIT_PROJECT -o custom-columns=":spec.host" | grep minio-api)
    envsubst < components/create-bucket-job/base/create-bucket-job-template.yaml > components/create-bucket-job/base/create-bucket-job.yaml
    oc create configmap -n ${SUMMIT_PROJECT} model-config-file
    oc apply -k ./components/create-bucket-job/base
  args:
    chdir: ~/elyra_docling_rh_summit
  environment:
    SUMMIT_PROJECT: granite-model-project

- name: Setup the model project - Install pip dependencies
  ansible.builtin.shell: |
    python -m pip install huggingface_hub=={{ bootstrap_huggingface_hub_version }}
    python -m pip install boto3=={{ bootstrap_boto3_version }}

- name: Setup the model project - Download model
  ansible.builtin.shell: |
    python components/model-server/download-model.py
  args:
    chdir: ~/elyra_docling_rh_summit

- name: Setup the model project - Create bucket job
  ansible.builtin.shell: |
    export MINIO_API_URL=$(oc get routes -n $SUMMIT_PROJECT -o custom-columns=":spec.host" | grep minio-api)
    python components/model-server/model-folder-upload.py
  args:
    chdir: ~/elyra_docling_rh_summit
  retries: 60
  delay: 10
  register: r_model_project
  until: r_model_project is not failed

- name: Setup the model project - Create bucket job
  ansible.builtin.shell: |
    oc apply -f components/model-server/sa-secret-token.yaml
    oc apply -f components/model-server/granite2b-conn.yaml
    oc apply -f components/model-server/model-namespace.yaml
    oc apply -f components/model-server/servingruntimes.yaml
    oc apply -f components/model-server/inferenceservice.yaml
  args:
    chdir: ~/elyra_docling_rh_summit

- name: Get model token secret
  k8s_info:
    api_version: v1
    kind: Secret
    name: default-name-granite2b-sa
    namespace: granite-model-project
  register: r_secret
  retries: 180
  delay: 10
  until:
  - r_secret.resources | length > 0

- name: Set model service token secret fact
  set_fact:
    bastion_role_model_service_token: "{{ r_secret.resources[0].data.token | b64decode }}"
